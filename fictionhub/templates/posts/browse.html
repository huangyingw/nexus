{% extends "base.html" %}
{% load staticfiles %}
{% load markdownify %}
{% load firstparagraph %}

{% block content %}



<style>
  p {
  margin-bottom:0;
  }
  .readmore {
  display:none;
  }

  hr {
    margin-bottom: 10px;
  }
  .posts-page .post-header h1 {
    font-size: 32px;
  }


  #search-hubs .hub-tag {
  padding:10px;
  margin:20px 0;
  }

  #search-hubs .hub-tag i{
  cursor:pointer;
  }    
.second-lvl .hub-tag {
display:block;
}

.sidebar .hub-tag {
  background: rgba(119, 119, 119, 0.1);
}

.sidebar .hub-tag .number-of-stories {
position: absolute;
right: 48px;
line-height: 30px;
margin-top: 6px;
}
  
.children {
padding: 0px;
  }

.posts .hub-tag {
display:block;
float:left;
margin-right: 5px;
}  
.second-lvl .hub-tag {
display:block;
}

.sidebar .hub-tag {
  background: rgba(119, 119, 119, 0.1);
}

.sidebar .hub-tag .number-of-stories {
position: absolute;
right: 48px;
line-height: 30px;
margin-top: 6px;
}
  
.children {
padding: 0px;
}

</style>


<div id="page"  class="posts-page">



  
<div class="row">

  <div class="large-4 small-4 columns sidebar"> <!-- style="display:none;" -->
  {% include "elements/sidebar.html" %}  
  </div>

  <div class="large-8 small-8 columns posts">
    {% if request.path = "/" and userprofile%}    
    {% include "posts/editor.html" %}
    {% else %}        
    {% include "posts/subnav-browse.html" %}
    {% endif %}        

    {% for post in posts %}
    {% if not post.author.shadowban or post.author = user %}    
    <article style="padding:20px;    background: rgba(255,255,255,0.5);//#fff;
		    box-shadow: 0 1px 4px rgba(0,0,0,.04);
		    border: 1px solid rgba(0,0,0,.09);
		    border-radius: 3px;
		    padding-bottom:0;">
      
      <!-- Post Body -->
      {{post | markdownify:"True" | safe  }} <!-- firstparagraph -->
      <div class="clearfix"></div>
      <!-- Post Footer -->
      <br/>
      {% include "elements/post-footer.html" %}
      <div class="clearfix"></div>
    </article>
    {% endif %}	<!-- endif shadowban -->
    {% endfor %}

    <!-- Pagination -->
    {% include "elements/pagination.html" %}
</div> <!-- End 8 columns -->



</div>	 <!-- End row -->
</div>	 <!-- end page -->

<div class="clearfix"></div>


<script>

$(document).ready(function(){
    function refreshHubs() {
	$('select#hubs-multiselect').each(function(){
	    var selectedHubs = $(this).val();
	    $('#search-hubs').empty();

	    if (!selectedHubs) {
		selectedHubs = [];
	    }

	    for (var i = 0; i < selectedHubs.length; i++) {
		hub = selectedHubs[i];
		title = $('select#hubs-multiselect').children('option#'+hub).text()
		el = $("<div class='hub-tag'>"+title+"<i class='fi-x right' id='"+hub+"'></i></div>");
		$('#search-hubs').append(el);
	    }
	});

	// Delete
	$('#search-hubs').find("i").click(function(){
	    $('#hubs-multiselect option[value=' + $(this).attr('id') + ']').attr('selected', false);
	    //refreshHubs();
	    $("#search-form").submit();	
	});
	
    }    
    

    // Multiselect
    refreshHubs();

    // Custom get request
    $('#search-form').submit(function(event){
	event.preventDefault();
	event.stopPropagation();

	if ($(this).attr('action')){
	    var action = $(this).attr('action');
	} else {
	    var action = "/browse/";
	}

       var action = "/browse/";
	var query = $('#search-input').val(); // attr("value")

	var hubs = [];
	$('#hubs-multiselect').children('option:selected').each(function(){
	    hubs.push(this.value);
	});

	if (query){
	    var query = '?query=' + query;
	} else {
	    var query = ""
	}
	
	if (query && hubs.length > 0){
	    var hubs = '&hubs=' + hubs.join(',');
	} else if (hubs.length > 0) {
	    var hubs = '?hubs=' + hubs.join(',');	
	} else {
	    var hubs = ""
	}
	window.location = action + query + hubs; // "http://{{request.META.HTTP_HOST}}" + 
    });

    // Hot/New/Top. Submit a form instead of following a link
    // $(".rank-types").find("a").bind('click',function(event){
    // 	event.preventDefault();
    // 	event.stopPropagation();
    // 	var link = $(this).attr('href');
    // 	$("#search-form").get(0).setAttribute('action', link)
    // 	$("#search-form").submit();
    // });


    // Select hubs when clicking on one in a sidebar
    var selector = $('select#hubs-multiselect');
    // $(".hubs").find(".hub-link").bind('click',function(event){
    // 	event.preventDefault();
    // 	event.stopPropagation();
    // 	var hub = $(this).attr('id');
    // 	console.log("select " + hub);
    // 	$('#hubs-multiselect option[value=' + hub + ']').attr('selected', true);
    // 	//refreshHubs();
    // 	$("#search-form").submit();	
    // });
    
    // open sidebar if there are some hubs selected
    {% if not userprofile %}
    if ($('select#hubs-multiselect').val()){
    	$(".posts").removeClass("large-12");
    	$(".posts").removeClass("small-12");  	      
    	$(".posts").addClass("large-9");
    	$(".posts").addClass("small-9");	      
    	$(".sidebar").show();
    	$("#toggle-hubs").addClass("expanded");
    }
    {% endif %}
    // Open sidebar by default
  {% if request.path = "/" and False %}    
    {% if not solohub %}
     $(".posts").removeClass("large-12");
     $(".posts").removeClass("small-12");  	      
     $(".posts").addClass("large-9");
     $(".posts").addClass("small-9");	      
     $(".sidebar").show();
     $("#toggle-hubs").addClass("expanded");
    {% endif %}
  {% endif %}	        
    

    // If there's search input, search field is white
    if ($('#search-input').val().length > 0){
    	// $('#search-input').style.background="white";
    	// $('#search-input').css("backround","white");
	$('#search-input').addClass("white-bg");
    }
})

document.onkeydown=function(){
    if(window.event.keyCode=='13'){
	if ($("#search-input").attr("value").length === 0) {
	    $("#search-form").get(0).setAttribute('action', "/browse/top/all-time/");
	}
    }
}
</script>




{% endblock content %}

